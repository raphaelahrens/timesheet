#!/usr/bin/env python
# -*- coding: utf-8 -*-

# CAVEAT UTILITOR
#
# This file was automatically generated by Tatsu.
#
#    https://pypi.python.org/pypi/tatsu/
#
# Any changes you make to it will be overwritten the next time
# the file is generated.


from __future__ import print_function, division, absolute_import, unicode_literals

from tatsu.buffering import Buffer
from tatsu.parsing import graken, Parser
from tatsu.util import re, RE_FLAGS, generic_main  # noqa


KEYWORDS = {}


class TimeSheetBuffer(Buffer):
    def __init__(
        self,
        text,
        whitespace=None,
        nameguard=None,
        comments_re=None,
        eol_comments_re=None,
        ignorecase=None,
        namechars='',
        **kwargs
    ):
        super(TimeSheetBuffer, self).__init__(
            text,
            whitespace=whitespace,
            nameguard=nameguard,
            comments_re=comments_re,
            eol_comments_re=eol_comments_re,
            ignorecase=ignorecase,
            namechars=namechars,
            **kwargs
        )


class TimeSheetParser(Parser):
    def __init__(
        self,
        whitespace=None,
        nameguard=None,
        comments_re=None,
        eol_comments_re=None,
        ignorecase=None,
        left_recursion=False,
        parseinfo=True,
        keywords=None,
        namechars='',
        buffer_class=TimeSheetBuffer,
        **kwargs
    ):
        if keywords is None:
            keywords = KEYWORDS
        super(TimeSheetParser, self).__init__(
            whitespace=whitespace,
            nameguard=nameguard,
            comments_re=comments_re,
            eol_comments_re=eol_comments_re,
            ignorecase=ignorecase,
            left_recursion=left_recursion,
            parseinfo=parseinfo,
            keywords=keywords,
            namechars=namechars,
            buffer_class=buffer_class,
            **kwargs
        )

    @graken()
    def _start_(self):

        def block0():
            self._line_()
        self._closure(block0)
        self._check_eof()

    @graken()
    def _line_(self):
        with self._choice():
            with self._option():
                self._unfinished_()
            with self._option():
                self._work_line_()
            with self._option():
                self._special_line_()
            with self._option():
                self._sum_line_()
            with self._option():
                self._balance_line_()
            self._error('no available options')

    @graken()
    def _special_line_(self):
        self._weekday_()
        self.name_last_node('weekday')
        self._date_()
        self.name_last_node('date')
        self._string_()
        self.name_last_node('comment')
        with self._optional():
            self._token('|')
        self.ast._define(
            ['comment', 'date', 'weekday'],
            []
        )

    @graken()
    def _start_time_(self):
        self._time_()
        self.name_last_node('start')
        self._token('--')
        self.ast._define(
            ['start'],
            []
        )

    @graken()
    def _time_span_(self):
        self._time_()
        self.name_last_node('start')
        self._token('--')

        self._time_()
        self.name_last_node('end')
        with self._optional():
            self._token('(')
            self._diff_()
            self.name_last_node('pause')
            self._token(')')
        self.ast._define(
            ['end', 'pause', 'start'],
            []
        )

    @graken()
    def _opt_extra_(self):
        self._diff_()
        self.name_last_node('total')
        self._token('=>')
        self._diff_()
        self.name_last_node('saldo')
        self.ast._define(
            ['saldo', 'total'],
            []
        )

    @graken()
    def _unfinished_(self):
        self._weekday_()
        self.name_last_node('weekday')
        self._date_()
        self.name_last_node('date')

        def block3():
            self._time_span_()
        self._closure(block3)
        self.name_last_node('time_spans')
        self._time_()
        self.name_last_node('start')
        self._token('--')
        self.ast._define(
            ['date', 'start', 'time_spans', 'weekday'],
            []
        )

    @graken()
    def _work_line_(self):
        self._weekday_()
        self.name_last_node('weekday')
        self._date_()
        self.name_last_node('date')

        def block3():
            self._time_span_()
        self._positive_closure(block3)
        self.name_last_node('time_spans')
        with self._optional():
            self._token('|')
            self._diff_()
            self.name_last_node('total')
            self._token('=>')
            self._diff_()
            self.name_last_node('saldo')
        self.ast._define(
            ['date', 'saldo', 'time_spans', 'total', 'weekday'],
            []
        )

    @graken()
    def _sum_line_(self):
        self._token('=>')
        self._diff_()
        self.name_last_node('total')
        self._token('-')
        self._diff_()
        self.name_last_node('breaks')
        self._token('-')
        self._diff_()
        self.name_last_node('soll')
        self._token('=')
        self._token('(')
        self._diff_()
        self.name_last_node('work')
        self._token(',')
        self._diff_()
        self.name_last_node('diff')
        self._token(')')
        self.ast._define(
            ['breaks', 'diff', 'soll', 'total', 'work'],
            []
        )

    @graken()
    def _balance_line_(self):
        self._token('->')
        self._token('Balance')
        self._token('=')
        self._diff_()
        self.name_last_node('@')

    @graken()
    def _date_(self):
        self._DD_()
        self.name_last_node('day')
        self._token('.')
        self._DD_()
        self.name_last_node('month')
        self._token('.')
        self._YEAR_()
        self.name_last_node('year')
        self.ast._define(
            ['day', 'month', 'year'],
            []
        )

    @graken()
    def _time_(self):
        self._DD_()
        self.name_last_node('hour')
        self._token(':')
        self._DD_()
        self.name_last_node('minute')
        self.ast._define(
            ['hour', 'minute'],
            []
        )

    @graken()
    def _diff_(self):
        self._SIGN_()
        self.name_last_node('sign')
        self._ND_()
        self.name_last_node('hours')
        self._token(':')
        self._DD_()
        self.name_last_node('minutes')
        self.ast._define(
            ['hours', 'minutes', 'sign'],
            []
        )

    @graken()
    def _DD_(self):
        self._pattern(r'\d\d')

    @graken()
    def _YEAR_(self):
        self._pattern(r'\d\d\d\d')

    @graken()
    def _ND_(self):
        self._pattern(r'\d+')

    @graken()
    def _SIGN_(self):
        with self._group():
            with self._choice():
                with self._option():
                    self._token('-')
                with self._option():
                    self._constant('+')
                self._error('expecting one of: -')

    @graken()
    def _EOL_(self):
        self._pattern(r'\n')

    @graken()
    def _weekday_(self):
        with self._choice():
            with self._option():
                self._token('Mon')
            with self._option():
                self._token('Tue')
            with self._option():
                self._token('Wed')
            with self._option():
                self._token('Thu')
            with self._option():
                self._token('Fri')
            with self._option():
                self._token('Sat')
            with self._option():
                self._token('Sun')
            self._error('expecting one of: Fri Mon Sat Sun Thu Tue Wed')

    @graken()
    def _string_(self):
        self._pattern(r'"[^"]*"')


class TimeSheetSemantics(object):
    def start(self, ast):
        return ast

    def line(self, ast):
        return ast

    def special_line(self, ast):
        return ast

    def start_time(self, ast):
        return ast

    def time_span(self, ast):
        return ast

    def opt_extra(self, ast):
        return ast

    def unfinished(self, ast):
        return ast

    def work_line(self, ast):
        return ast

    def sum_line(self, ast):
        return ast

    def balance_line(self, ast):
        return ast

    def date(self, ast):
        return ast

    def time(self, ast):
        return ast

    def diff(self, ast):
        return ast

    def DD(self, ast):
        return ast

    def YEAR(self, ast):
        return ast

    def ND(self, ast):
        return ast

    def SIGN(self, ast):
        return ast

    def EOL(self, ast):
        return ast

    def weekday(self, ast):
        return ast

    def string(self, ast):
        return ast


def main(filename, startrule, **kwargs):
    with open(filename) as f:
        text = f.read()
    parser = TimeSheetParser()
    return parser.parse(text, startrule, filename=filename, **kwargs)


if __name__ == '__main__':
    import json
    from tatsu.util import asjson

    ast = generic_main(main, TimeSheetParser, name='TimeSheet')
    print('AST:')
    print(ast)
    print()
    print('JSON:')
    print(json.dumps(asjson(ast), indent=2))
    print()
